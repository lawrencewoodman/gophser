package require tcltest
namespace import tcltest::*

apply {{} {
  set thisScriptDir [file dirname [info script]]
  set moduleDir [file normalize [file join $thisScriptDir ..]]
  set modules [lsort -decreasing [glob -directory $moduleDir gophser-*.tm]]
  source [lindex $modules 0]
  source [file join $thisScriptDir test_helpers.tcl]
  TestHelpers::setRepoRootDir $moduleDir
}}


# TODO: Don't refer to render and check for .<cr><lf> in menu
test process-1 {Check render adds correct .<cr><lf> ending to menu} \
-setup {
  set m [gophser::menu create]
  set fixturesDir [file join [TestHelpers::getRepoRootDir] tests fixtures]
  set selector "/"
} -body {
  set m [gophser::gophermap::process $m $fixturesDir $selector "/" ""]
  gophser::menu render $m
} -result [string cat \
  "0README.md - find all about this directory\tREADME.md\tlocalhost\t70\r\n" \
  "1The example.com site\t/\texample.com\t70\r\n" \
  "1error\t/error\tlocalhost\t70\r\n" \
  "1includes\t/includes\tlocalhost\t70\r\n" \
  "1sourcing\t/sourcing\tlocalhost\t70\r\n" \
  "1titles\t/titles\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "0Documentation\t/docs.txt\tlocalhost\t70\r\n" \
  "iDid you know that there is some interesting information in some documentation\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "0hello.txt\t/hello.txt\tlocalhost\t70\r\n" \
  "iThis is a description of hello.txt it is generated using the describe command\tFAKE\tlocalhost\t70\r\n" \
  "iand this demonstrates how it will wrap the text\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "0hi.txt\t/hi.txt\tlocalhost\t70\r\n" \
  "0README.md\t/README.md\tlocalhost\t70\r\n" \
  ".\r\n"]


test process-2 {Check returns errors properly} \
-setup {
  set fixturesDir [file join [TestHelpers::getRepoRootDir] tests fixtures ]
  set errorDir [file join $fixturesDir error]
  set m [gophser::menu create]
  set selector "/"
} -body {
  set m [gophser::gophermap::process $m $errorDir $selector "/" ""]
  gophser::menu render $m
} -returnCodes {error} -result {error processing: /home/lorry/data/dev/lib/gophser/tests/fixtures/error/gophermap, for selector: /, can't read "b": no such variable}


test process-3 {Check headers display properly} \
-setup {
  set m [gophser::menu create]
  set fixturesDir [file join [TestHelpers::getRepoRootDir] tests fixtures titles]
  set selector "/"
} -body {
  set m [gophser::gophermap::process $m $fixturesDir $selector "/" ""]
  gophser::menu render $m
} -result [string cat \
  "i============================\tFAKE\tlocalhost\t70\r\n" \
  "i= A Nice Big Size 1 Header =\tFAKE\tlocalhost\t70\r\n" \
  "i============================\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "i=======\tFAKE\tlocalhost\t70\r\n" \
  "i= Big =\tFAKE\tlocalhost\t70\r\n" \
  "i=======\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "iA Medium Size 2 Header\tFAKE\tlocalhost\t70\r\n" \
  "i======================\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "iMedium\tFAKE\tlocalhost\t70\r\n" \
  "i======\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "iA Small Size 3 Header\tFAKE\tlocalhost\t70\r\n" \
  "i---------------------\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "ismall\tFAKE\tlocalhost\t70\r\n" \
  "i-----\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  ".\r\n"]


test process-4 {Check source loads and evals a file} \
-setup {
  set fixturesDir [file join [TestHelpers::getRepoRootDir] tests fixtures ]
  set sourcingDir [file join $fixturesDir sourcing]
  set includesDir [file join $fixturesDir includes]
  # TODO: Put includeDir within some sort of config under gophser::
  gophser::gophermap::setIncludeDir $includesDir
  set m [gophser::menu create]
  set selector "/"
} -body {
  set m [gophser::gophermap::process $m $sourcingDir $selector "/" ""]
  gophser::menu render $m
} -result [string cat \
  "i== Sourcing ==\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "iWelcome Peter\tFAKE\tlocalhost\t70\r\n" \
  "i\tFAKE\tlocalhost\t70\r\n" \
  "iThe end\tFAKE\tlocalhost\t70\r\n" \
  ".\r\n"]


cleanupTests
